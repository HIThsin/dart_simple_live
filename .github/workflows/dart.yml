name: 同步上游仓库并打包 Android

on:
  # 定时触发 - 每天北京时间早上 8 点运行 (UTC 0:00)
  schedule:
    - cron: '0 0 * * *'
  # 手动触发
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  UPSTREAM_REPO: 'https://github.com/xiaoyaocz/dart_simple_live.git'
  UPSTREAM_BRANCH: 'master'
  FLUTTER_VERSION: '3.38.x'

jobs:
  sync-upstream:
    name: 同步上游仓库
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.sync.outputs.has_changes }}
      new_version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 配置 Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 添加上游仓库
        run: |
          git remote add upstream ${{ env.UPSTREAM_REPO }} || true
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: 检查更新并同步
        id: sync
        run: |
          # 获取本地和上游的最新提交
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
          
          echo "本地提交: $LOCAL_COMMIT"
          echo "上游提交: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "检测到上游有更新，开始同步..."
            git merge upstream/${{ env.UPSTREAM_BRANCH }} --allow-unrelated-histories -m "同步上游仓库" || true
            git push origin HEAD
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "已是最新版本，无需同步"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: 读取版本信息
        id: version
        run: |
          if [ -f "assets/app_version.json" ]; then
            VERSION=$(cat assets/app_version.json | jq -r '.version // "unknown"')
          else
            VERSION=$(grep 'version:' simple_live_app/pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "版本号: $VERSION"

  build-android:
    name: 打包 Android APK
    runs-on: ubuntu-latest
    needs: sync-upstream
    # 有更新时构建，或手动触发时强制构建
    if: needs.sync-upstream.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: 设置 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 验证 Flutter 环境
        run: flutter doctor -v

      - name: 修复 build.gradle.kts 签名配置
        run: |
          # 修复签名配置，使其在 key.properties 不存在时不会报错
          cat > simple_live_app/android/app/build.gradle.kts << 'EOF'
          import java.util.Properties
          import java.io.FileInputStream

          plugins {
              id("com.android.application")
              id("kotlin-android")
              id("dev.flutter.flutter-gradle-plugin")
          }

          val keystoreProperties = Properties()
          val keystorePropertiesFile = rootProject.file("key.properties")
          val hasKeystore = keystorePropertiesFile.exists()
          if (hasKeystore) {
              keystoreProperties.load(FileInputStream(keystorePropertiesFile))
          }

          android {
              namespace = "com.xycz.simple_live"
              compileSdk = flutter.compileSdkVersion
              ndkVersion = flutter.ndkVersion

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_11
                  targetCompatibility = JavaVersion.VERSION_11
              }

              kotlinOptions {
                  jvmTarget = JavaVersion.VERSION_11.toString()
              }

              defaultConfig {
                  applicationId = "com.xycz.simple_live"
                  minSdk = flutter.minSdkVersion
                  targetSdk = flutter.targetSdkVersion
                  versionCode = flutter.versionCode
                  versionName = flutter.versionName
              }

              if (hasKeystore) {
                  signingConfigs {
                      create("release") {
                          keyAlias = keystoreProperties["keyAlias"] as String
                          keyPassword = keystoreProperties["keyPassword"] as String
                          storeFile = keystoreProperties["storeFile"]?.let { file(it) }
                          storePassword = keystoreProperties["storePassword"] as String
                          isV1SigningEnabled = true
                          isV2SigningEnabled = true
                      }
                  }
              }

              buildTypes {
                  release {
                      signingConfig = if (hasKeystore) {
                          signingConfigs.getByName("release")
                      } else {
                          signingConfigs.getByName("debug")
                      }
                      isMinifyEnabled = true
                      isShrinkResources = true
                      proguardFiles(
                          getDefaultProguardFile("proguard-android-optimize.txt"),
                          "proguard-rules.pro"
                      )
                  }
              }
          }

          flutter {
              source = "../.."
          }
          EOF
          # 移除 heredoc 产生的前导空格
          sed -i 's/^          //' simple_live_app/android/app/build.gradle.kts

      - name: 获取依赖
        run: |
          cd simple_live_app
          flutter pub get

      # ========== Debug 构建 ==========
      - name: 构建 Debug APK
        if: github.event.inputs.build_type != 'release'
        run: |
          cd simple_live_app
          flutter build apk --debug

      - name: 上传 Debug APK
        if: github.event.inputs.build_type != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: simple-live-debug-${{ needs.sync-upstream.outputs.new_version }}
          path: simple_live_app/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

      # ========== Release 构建 ==========
      - name: 解码签名密钥
        if: github.event.inputs.build_type == 'release'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "::error::未配置签名密钥，无法构建 Release 版本"
            exit 1
          fi
          echo $KEYSTORE_BASE64 | base64 --decode > simple_live_app/android/keystore.jks

      - name: 创建 key.properties
        if: github.event.inputs.build_type == 'release'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > simple_live_app/android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../keystore.jks
          EOF

      - name: 构建 Release APK
        if: github.event.inputs.build_type == 'release'
        run: |
          cd simple_live_app
          flutter build apk --release --split-per-abi

      - name: 上传 Release APK
        if: github.event.inputs.build_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: simple-live-release-${{ needs.sync-upstream.outputs.new_version }}
          path: |
            simple_live_app/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            simple_live_app/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            simple_live_app/build/app/outputs/flutter-apk/app-x86_64-release.apk
          retention-days: 30

  # 可选：创建 Release 发布
  create-release:
    name: 创建 Release 发布
    runs-on: ubuntu-latest
    needs: [sync-upstream, build-android]
    if: github.event.inputs.build_type == 'release' && needs.sync-upstream.outputs.has_changes == 'true'
    permissions:
      contents: write
    
    steps:
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: simple-live-release-${{ needs.sync-upstream.outputs.new_version }}
          path: ./apks

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.sync-upstream.outputs.new_version }}-auto
          name: Simple Live v${{ needs.sync-upstream.outputs.new_version }} (自动构建)
          body: |
            ## 自动构建版本
            
            此版本由 GitHub Actions 自动从上游仓库同步并构建。
            
            **上游仓库**: https://github.com/xiaoyaocz/dart_simple_live
            **版本**: ${{ needs.sync-upstream.outputs.new_version }}
            **构建时间**: ${{ github.event.repository.updated_at }}
            
            ### 下载说明
            - `app-arm64-v8a-release.apk` - 适用于大多数现代 Android 手机
            - `app-armeabi-v7a-release.apk` - 适用于较老的 Android 手机
            - `app-x86_64-release.apk` - 适用于 x86 模拟器或特殊设备
          files: ./apks/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}

